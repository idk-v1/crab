<!DOCTYPE html>
<canvas width="1000%" height="1000%" style="position: fixed; top: 0%; left: 50%; image-rendering: pixelated; transform: translate(-50%);" id="cnv"></canvas>
<center id="title" style="position: fixed; top: 20%; left: 50%; color: #dfdfdf; font-weight: 900; font-size: 200%; transform: translate(-50%); width: 100%; text-shadow: 2px 2px #8f8fff; user-select: none;">[PLACEHOLDER CRAB GAME NAME]</center>
<center id="strt" style="position: fixed; top: 65%; left: 45%; background-color: #1f1f5f; width: 10%; height: 7.5%; cursor: pointer; border-color: #4f4f7f; border-width: 2.5px; border-style: outset; transform: translate( -5%);" onclick="setup()" onmouseover="mouseover()" onmouseout="mouseout()"></center>
<center id="bttntxt" style="position: fixed; top: 67.5%; left: 50%; color: #7f7fcf; font-weight: 700; cursor: pointer; font-size: 100%; transform: translate(-55%); width: 5%; user-select: none;" onclick="setup()" onmouseover="mouseover()" onmouseout="mouseout()">START</center>
<img src="textures/shell1.png" id="menushell" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<img src="textures/crack_small.png" id="menucracks" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<img src="textures/crab1.png" id="menucrab" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<img src="textures/sign_play.png" id="menusign" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<!-- video style="position: fixed; width: 100%; height: 100%; display: none;" id="win" src="textures/crabrave.mp4"></video -->
<div style="position: fixed; top: 0%; left: 0%; color: white; font-weight: 400; font-family: 'Courier New', Courier, monospace;" id="pos"></div>
<img src="textures/cr.png" style="user-select: none; -moz-user-select: none; transform: translate(-50% -50%); position: fixed; display: none; image-rendering: pixelated;" id="right" dragable = "false" ></img>
<img src="textures/cl.png" style="user-select: none; -moz-user-select: none; transform: translate(-50% -50%); position: fixed; display: none; image-rendering: pixelated;" id="left" dragable = "false" ></img>
<img src="textures/cu.png" style="user-select: none; -moz-user-select: none; transform: translate(-50% -50%); position: fixed; display: none; image-rendering: pixelated;" id="up" dragable = "false" ></img>
<img src="textures/cd.png" style="user-select: none; -moz-user-select: none; transform: translate(-50% -50%); position: fixed; display: none; image-rendering: pixelated;" id="down" dragable = "false" ></img>
<img src="textures/ch.png" style="user-select: none; -moz-user-select: none; transform: translate(-50% -50%); position: fixed; display: none; image-rendering: pixelated;" id="hide" dragable = "false" ></img>
<script src="textures/textures.js"></script>
<script>

    //Main Menu
    let menucrab = 0;
    let mnucrabpos = 0;
    let craban = 0;
    let mnucrab = document.getElementById('menucrab');
    let mnushell = document.getElementById('menushell');
    let mnucracks = document.getElementById('menucracks');
    let mnusign = document.getElementById('menusign');
    mnusign.style.transform = "rotate(0)";
    mnushell.style.transform = "rotate(0)";
    mnucrab.style.transform = "rotate(0)";
    mnucracks.style.transform = "rotate(0)";
    mnucracks.style.display = "none";

    //Canvas
    let cnv = document.getElementById('cnv');
    let ctx = cnv.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    //Menu screen
    let mm = true;
    document.querySelector('body').style.backgroundColor = "#222233";
    document.addEventListener('contextmenu', event => event.preventDefault());

    //Time
    let time = 0;
    let dt = 0;
    let lastTime = performance.now();
    let play = true;
    let alt = 0;

    //Controls
    let up = false, left = false, right = false, enter = false, shift = false, down = false, touch = false;
    let rc = document.getElementById("right");
    let lc = document.getElementById("left");
    let uc = document.getElementById("up");
    let dc = document.getElementById("down");
    let hc = document.getElementById('hide');
    rc.style.width = window.innerWidth / 20 + "px"; rc.style.height = window.innerWidth / 20 + "px"; rc.style.right = (window.innerWidth / 20 + 16) * 0 + "px"; rc.style.bottom = (window.innerWidth / 20 + 16) * 1 + "px";
    lc.style.width = window.innerWidth / 20 + "px"; lc.style.height = window.innerWidth / 20 + "px"; lc.style.right = (window.innerWidth / 20 + 16) * 2 + "px"; lc.style.bottom = (window.innerWidth / 20 + 16) * 1 + "px";
    uc.style.width = window.innerWidth / 20 + "px"; uc.style.height = window.innerWidth / 20 + "px"; uc.style.right = (window.innerWidth / 20 + 16) * 1 + "px"; uc.style.bottom = (window.innerWidth / 20 + 16) * 2 + "px";
    dc.style.width = window.innerWidth / 20 + "px"; dc.style.height = window.innerWidth / 20 + "px"; dc.style.right = (window.innerWidth / 20 + 16) * 1 + "px"; dc.style.bottom = (window.innerWidth / 20 + 16) * 0 + "px";
    hc.style.width = window.innerWidth / 20 + "px"; hc.style.height = window.innerWidth / 20 + "px"; hc.style.right = (window.innerWidth / 20 + 16) * 1 + "px"; hc.style.bottom = (window.innerWidth / 20 + 16) * 1 + "px";
    rc.addEventListener('touchstart', function(event) {right = true});
    lc.addEventListener('touchstart', function(event) {left = true});
    uc.addEventListener('touchstart', function(event) {up = true});
    dc.addEventListener('touchstart', function(event) {down = true}); 
    hc.addEventListener('touchstart', function(event) {hidden = true}); 
    rc.addEventListener('touchend', function(event) {right = false});
    lc.addEventListener('touchend', function(event) {left = false});
    uc.addEventListener('touchend', function(event) {up = false});
    dc.addEventListener('touchend', function(event) {down = false});  
    hc.addEventListener('touchend', function(event) {hidden = false});      

    //Player
    let x = 0, y = 0, d = 1, h = 0, xv = 0, yv = 0, speed = 0.125, hidden = false, inWater = false;

    //setup();
    let int = setInterval(tick, 0);


    function mouseover() {
        document.getElementById('strt').style.backgroundColor = '#2f2f6f';
    }
    function mouseout() {
        document.getElementById('strt').style.backgroundColor = '#1f1f5f';
    }

    function crabclick() {
        menucrab++;
        setTimeout(function() {
            mnucrab.style.filter = "brightness(150%)";
            mnucrab.style.transform = "rotate(15deg)";
            mnucracks.style.filter = "brightness(150%)";
            mnucracks.style.transform = "rotate(15deg)";
            mnushell.style.filter = "brightness(150%)";
            mnushell.style.transform = "rotate(15deg)";
            mnusign.style.transform = "rotate(15deg)";
        }, 150);
        setTimeout(function() {
            mnucrab.style.transform = "rotate(-15deg)";
            mnucrab.style.filter = "brightness(100%)";
            mnucracks.style.transform = "rotate(-15deg)";
            mnucracks.style.filter = "brightness(100%)";
            mnushell.style.transform = "rotate(-15deg)";
            mnushell.style.filter = "brightness(100%)";
            mnusign.style.transform = "rotate(-15deg)";
        }, 400);
        setTimeout(function() {
            mnucrab.style.transform = "rotate(0)";
            mnucracks.style.transform = "rotate(0)";
            mnushell.style.transform = "rotate(0)";
            mnusign.style.transform = "rotate(0)";
        }, 525);
        if (menucrab == 15) {mnucracks.style.display = "none"; mnushell.style.display = "none"; mnusign.src = "textures/sign_f.png";} 
        else if (menucrab >= 10 && menucrab <= 14) mnucracks.src = "textures/crack_large.png";
        else if (menucrab >= 5 && menucrab <= 9) mnucracks.style.display = "initial";
    }

    function tick() {
        alt += 0.125;
        if (alt >= 64) alt = 0;
        let now = performance.now();
        dt += now - lastTime;
        lastTime = now;
        while (dt >= 1000 / 60) {
            dt -= 1000 / 60;
            update();
        }
        render();
    }

    function update() {

        if (touch) {
            rc.style.display = "block";
            lc.style.display = "block";
            uc.style.display = "block";
            dc.style.display = "block";
            hc.style.display = "block";
        } else {
            rc.style.display = "none";
            lc.style.display = "none";
            uc.style.display = "none";
            dc.style.display = "none";
            hc.style.display = "none";
        }

        cnv.width = window.innerHeight;
        cnv.height = window.innerHeight;

        if (!mm && !play) {cnv.style.filter = "blur(5px)";}
        else {cnv.style.filter = "blur(0px)";}

        if (menucrab >= 15 && mm) {
            craban++;
            if (craban >= 20) {craban = 0; mnucrab.src = "textures/crab1.png";}
            else if (craban >= 15) {mnucrab.src = "textures/crab1w1mm.png";}
            else if (craban >= 10) {mnucrab.src = "textures/crab1w2mm.png";}
            else if (craban >= 5) {mnucrab.src = "textures/crab1w3mm.png";}
            mnucrabpos++;
            mnucrab.style.left = `${45 - mnucrabpos / 7.5}%`;
            mnusign.style.left = `${45 - mnucrabpos / 7.5}%`;
        }

        if (!mm && play) {

            time++;
            if (time >= 10000) time = 0;

            if (
                world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 1 || 
                world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 2 || 
                world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 3 || 
                world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 4 || 
                world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 5
                ) inWater = true;
            else inWater = false;

            if (left && -x > 0 && world1[Math.round((Math.ceil((-x - 13) / 48)) + (Math.floor(-y / 48)) * world1w) - 1] != 0) {
                xv += 10;
            }
            if (right && -x < world1w * 48 - 13 && world1[Math.round((Math.floor((-x + 13) / 48)) + (Math.floor(-y / 48)) * world1w)] != 0) {
                xv += -10;
            }
            if (up && -y > 0 && world1[Math.round((Math.floor(-x / 48)) + (Math.floor((-y - 13) / 48)) * world1w)] != 0) {
                yv += 10;
            }
            if (down && -y < world1h * 48 - 13 && world1[Math.round((Math.floor(-x / 48)) + (Math.ceil((-y + 13) / 48)) * world1w) - world1w] != 0) {
                yv += -10;
            }
            if (-x < 0) x = 0;
            if (-x > world1w * 48) x = -world1w * 48 + 13;
            if (-y < 0) y = 0;
            if (-y > world1h * 48) y = -world1h * 48 + 13;
            xv = Math.round(xv + 2 * ((world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 2 ? 2 : 0) - (world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 4 ? 2 : 0))) / (inWater ? 2 : 1);
            yv = Math.round(yv + 2 * ((world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 1 ? 2 : 0) - (world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)] == 3 ? 2 : 0))) / (inWater ? 2 : 1);
            y += Math.round(yv / 2);
            x += Math.round(xv / 2);
            xv /= 10;
            yv /= 10;
        }
    }

    function render() {
        ctx.clearRect(0, 0, cnv.width, cnv.height);

        if (mm) {
            ctx.fillStyle = '#1f1f38';
            ctx.fillRect(0, 0, cnv.width, cnv.height);
        }

        if (!mm) {
            ctx.save();
            ctx.translate(x * Math.sin(47.125) + (385 * (cnv.height / 750)), y * Math.tan(47.125) + (400 * (cnv.height / 750)));
            ctx.scale(2 * (cnv.width / 1000), 1 * (cnv.height / 1000));
            ctx.rotate(45 * Math.PI / 180);
            for (let i = 0; i < world1.length; i++) {
                switch(world1[i]) {

                    //WATER
                    case 1:
                        ctx.drawImage(water1, 0, alt / 2, 32, 32, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 96);
                        break;
                    case 2:
                        ctx.drawImage(water2, alt / 2, 0, 32, 32, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 96, 48);
                        break;
                    case 3:
                        ctx.drawImage(water3, 0, 32 - alt / 2, 32, 32, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 96);
                        break;
                    case 4:
                        ctx.drawImage(water4, 32 - alt / 2, 0, 32, 32, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 96, 48);
                        break;
                    case 5:
                        ctx.drawImage(water5, 0, 0, 32, 32, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;

                    //SAND
                    case 6:
                        ctx.drawImage(sand1, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 7:
                        ctx.drawImage(sand2, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 8:
                        ctx.drawImage(sand3, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 9:
                        ctx.drawImage(sand4, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 10:
                        ctx.drawImage((i % 5 == 3 ? sand4 : i % 5 == 2 ? sand3 : i % 5 == 1 ? sand2 : sand1), (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;

                    case 11:
                        ctx.drawImage(moss1, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 12:
                        ctx.drawImage(moss2, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 13:
                        ctx.drawImage(moss3, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 14:
                        ctx.drawImage(moss4, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 15:
                        ctx.drawImage((i % 5 == 3 ? moss4 : i % 5 == 2 ? moss3 : i % 5 == 1 ? moss2 : moss1), (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;

                    case 16:
                        ctx.drawImage(grass1, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    case 21:
                        ctx.drawImage(dirt1, (i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48);
                        break;
                    default:
                        ctx.clearRect((i % world1w) * 48 + x, (Math.floor(i / world1w)) * 48 + y, 48, 48)
                }   
            }
            ctx.restore();
            ctx.save();
            ctx.translate(cnv.width / 2, cnv.height / 2);
            ctx.drawImage(crab1, 0, 0);
            ctx.restore();
            ctx.fillStyle = `rgba(
            ${((time >= 5000 ? 5000 - (time - 5000) : 5000 - (5000 - time)) / 37.5)},
            ${((time >= 5000 ? 5000 - (time - 5000) : 5000 - (5000 - time)) / 37.5)}, 
            ${((time >= 5000 ? (time - 5000) : (5000 - time)) / 37.5)}, 
            ${((time >= 5000 ? (time - 5000) : (5000 - time)) / 20000 + 0.125)}
            )`;

            ctx.fillRect(0, 0, cnv.width, cnv.height);
            document.getElementById('pos').innerHTML = `
            Position: ${(-x).toFixed(1)}x | ${Math.round(-y).toFixed(1)}y <br>
            Speed: ${(Math.abs(xv)).toFixed(1)}x | ${(Math.abs(yv)).toFixed(1)}y <br>
            Block ID: ${world1[Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)]} <br>
            Array: ${Math.round((Math.floor(-x / 48)) + (Math.floor(-y / 48)) * world1w)} / ${world1.length - 1} | ${world1w}w ${world1h}h <br>
            Canvas Size: ${cnv.width} x ${cnv.height} <br>
            Time: ${time} / 10000upd <br> 
            Overlay: 
            ${((time >= 5000 ? 5000 - (time - 5000) : 5000 - (5000 - time)) / 37.5).toFixed(1)}r |
            ${((time >= 5000 ? 5000 - (time - 5000) : 5000 - (5000 - time)) / 37.5).toFixed(1)}g |
            ${((time >= 5000 ? (time - 5000) : (5000 - time)) / 37.5).toFixed(1)}b |
            ${(((time >= 5000 ? (time - 5000) : (5000 - time)) / 20000 + 0.125) * 100).toFixed(1)}a <br>
            <span style="color: ${down ? '#00ff00' : '#ff0000'}">down</span>
            <span style="color: ${left ? '#00ff00' : '#ff0000'}">left</span>
            <span style="color: ${right ? '#00ff00' : '#ff0000'}">right</span>
            <span style="color: ${up ? '#00ff00' : '#ff0000'}">up</span>
            <span style="color: ${inWater ? '#00ff00' : '#ff0000'}">inWater</span>
            <span style="color: ${touch ? '#00ff00' : '#ff0000'}">touch</span>
            <span style="color: ${hidden ? '#00ff00' : '#ff0000'}">hidden</span>
            `;
        }
    }

    function setup() {
        mnucrab.remove();
        mnucracks.remove();
        mnushell.remove();
        mnusign.remove();
        document.getElementById('title').remove();
        document.getElementById('strt').remove();
        document.getElementById('bttntxt').remove();
        mm = false;

        //Keys
        document.addEventListener('keydown', function(event) {
        if (event.key == "a" || event.key == "A") {left = true; touch = false;}
        if (event.key == "d" || event.key == "D") {right = true; touch = false;}
        if (event.key == "w" || event.key == "W") {up = true; touch = false;}
        if (event.key == "s" || event.key == "S") {down = true; touch = false;}
        if (event.key == "Shift") {shift = true; hidden = true; touch = false;}
        if (event.key == "Enter") enter = true;
        });
        document.addEventListener('keyup', function(event) {
        if (event.key == "a" || event.key == "A") left = false;
        if (event.key == "d" || event.key == "D") right = false;
        if (event.key == "w" || event.key == "W") up = false;
        if (event.key == "s" || event.key == "S") down = false;
        if (event.key == "Shift") {shift = false; hidden = false;}
        if (event.key == "Enter") enter = false;
        if (event.key == "Escape") play = !play;
        });
        document.addEventListener('touchstart', function(event) {
            touch = true;
        });
    }

    function win() {
        document.getElementById('win').style.display = "block";
        document.getElementById('win').play();
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, cnv.width, cnv.height);
    }

</script>
<script src="world1.js"></script>
