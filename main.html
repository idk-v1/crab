<!DOCTYPE html>
<canvas width="1000%" height="500%" style="position: fixed; width: 100%; height: 100%; top: 0%; left: 0%; image-rendering: pixelated;" id="cnv"></canvas>
<center id="title" style="position: fixed; top: 20%; left: 50%; color: #dfdfdf; font-weight: 900; font-size: 375%; transform: translate(-50%); width: 100%; text-shadow: 2px 2px #8f8fff; user-select: none;">[PLACEHOLDER CRAB GAME NAME]</center>
<center id="strt" style="position: fixed; top: 65%; left: 45%; background-color: #1f1f5f; width: 10%; height: 7.5%; cursor: pointer; border-color: #4f4f7f; border-width: 2.5px; border-style: outset; transform: translate( -5%);" onclick="setup()" onmouseover="mouseover()" onmouseout="mouseout()"></center>
<center id="bttntxt" style="position: fixed; top: 67.5%; left: 50%; color: #7f7fcf; font-weight: 700; cursor: pointer; font-size: 100%; transform: translate(-55%); width: 5%; user-select: none;" onclick="setup()" onmouseover="mouseover()" onmouseout="mouseout()">START</center>
<img src="textures/shell1.png" id="menushell" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<img src="textures/crack_small.png" id="menucracks" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<img src="textures/crab1.png" id="menucrab" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<img src="textures/sign_play.png" id="menusign" style="position: fixed; top: 40%; left: 45%; transform: translate(-55%); width: 128px; height: 128px; image-rendering: pixelated; user-select: none; -moz-user-select: none;" onclick="crabclick()" draggable="false"></img>
<video style="position: fixed; width: 100%; height: 100%; display: none;" id="win" src="textures/crabrave.mp4"></video>
<div style="position: fixed; top: 0%; left: 0%;" id="pos"></div>
<script>

    //World
    let world1h = 10;
    let world1 = [
    0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 2, 3, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 2, 3, 4, 4, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 2, 3, 4, 4, 4, 4, 
    0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 3, 4, 4, 4, 4, 4, 4,
    ];
    let world1w = 20;
    let collisions = new Array(world1.length).fill(0);

    //Time
    let dt = 0;
    let lastTime = performance.now();
    let int = setInterval(tick, 0);
    let play = true;

    //Main Menu
    let menucrab = 0;
    let mnucrabpos = 0;
    let craban = 0;
    let mnucrab = document.getElementById('menucrab');
    let mnushell = document.getElementById('menushell');
    let mnucracks = document.getElementById('menucracks');
    let mnusign = document.getElementById('menusign');
    mnusign.style.transform = "rotate(0)";
    mnushell.style.transform = "rotate(0)";
    mnucrab.style.transform = "rotate(0)";
    mnucracks.style.transform = "rotate(0)";
    mnucracks.style.display = "none";

    //Controls
    let up = false, left = false, right = false, enter = false, shift = false, hide = false;

    //Player
    let x = 0, y = 0, d = 1, h = 0, xv = 0, yv = 0, grav = 1, onground = false, speed = 0.5, jump = 32, hidden = false;

    //Canvas
    let cnv = document.getElementById('cnv');
    let ctx = cnv.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    let bl0 = new Image();
    let bl1 = new Image();
    let bl2 = new Image();
    let bl3 = new Image();
    let bl4 = new Image();
    let bl5 = new Image();
    let bl6 = new Image();
    let crabmain = new Image();
    let shellmain = new Image();
    let sky = new Image();

    bl0.src = "textures/block0.png";
    bl1.src = "textures/block1.png";
    bl2.src = "textures/missing.png";
    bl3.src = "textures/block3.png";
    bl4.src = "textures/block4.png";
    bl5.src = "textures/missing.png";
    bl6.src = "textures/block6.png";
    crabmain.src = "textures/crab1.png";
    shellmain.src = "textures/shell1.png";
    sky.src = "textures/sky.png";

    //Keys
    document.addEventListener('keydown', function(event) {
        if (event.key == "a" || event.key == "A") left = true;
        if (event.key == "d" || event.key == "D") right = true;
        if (event.key == "w" || event.key == "W") up = true;
        if (event.key == "s" || event.key == "S") hide = true;
        if (event.key == "Shift") shift = true;
        if (event.key == "Enter") enter = true;
    });
    document.addEventListener('keyup', function(event) {
        if (event.key == "a" || event.key == "A") left = false;
        if (event.key == "d" || event.key == "D") right = false;
        if (event.key == "w" || event.key == "W") up = false;
        if (event.key == "s" || event.key == "S") hide = false;
        if (event.key == "Shift") shift = false;
        if (event.key == "Enter") enter = false;
        if (event.key == "Escape") play = !play;
    });

    //Menu screen
    let mm = true;
    ctx.fillStyle = '#1f1f38';
    ctx.fillRect(0, 0, cnv.width, cnv.height);
    function mouseover() {
        document.getElementById('strt').style.backgroundColor = '#2f2f6f';
    }
    function mouseout() {
        document.getElementById('strt').style.backgroundColor = '#1f1f5f';
    }

    function crabclick() {
        menucrab++;
        setTimeout(function() {
            mnucrab.style.filter = "brightness(150%)";
            mnucrab.style.transform = "rotate(15deg)";
            mnucracks.style.filter = "brightness(150%)";
            mnucracks.style.transform = "rotate(15deg)";
            mnushell.style.filter = "brightness(150%)";
            mnushell.style.transform = "rotate(15deg)";
            mnusign.style.transform = "rotate(15deg)";
        }, 150);
        setTimeout(function() {
            mnucrab.style.transform = "rotate(-15deg)";
            mnucrab.style.filter = "brightness(100%)";
            mnucracks.style.transform = "rotate(-15deg)";
            mnucracks.style.filter = "brightness(100%)";
            mnushell.style.transform = "rotate(-15deg)";
            mnushell.style.filter = "brightness(100%)";
            mnusign.style.transform = "rotate(-15deg)";
        }, 400);
        setTimeout(function() {
            mnucrab.style.transform = "rotate(0)";
            mnucracks.style.transform = "rotate(0)";
            mnushell.style.transform = "rotate(0)";
            mnusign.style.transform = "rotate(0)";
        }, 525);
        if (menucrab == 15) {mnucracks.style.display = "none"; mnushell.style.display = "none"; mnusign.src = "textures/sign_f.png";} 
        else if (menucrab >= 10 && menucrab <= 14) mnucracks.src = "textures/crack_large.png";
        else if (menucrab >= 5 && menucrab <= 9) mnucracks.style.display = "initial";
    }

    //Functions
    function tick() {
        let now = performance.now();
        dt += now - lastTime;
        lastTime = now;
        while (dt >= 1000 / 60) {
            dt -= 1000 / 60;
            update();
        }
        if (!mm)
            render();
    }

    function update() {

        if (!mm && !play) {cnv.style.filter = "blur(5px)";}
        else {cnv.style.filter = "blur(0px)";}

        if (menucrab >= 15 && mm) {
            craban++;
            if (craban >= 20) {craban = 0; mnucrab.src = "textures/crab1.png";}
            else if (craban >= 15) {mnucrab.src = "textures/crab1w1mm.png";}
            else if (craban >= 10) {mnucrab.src = "textures/crab1w2mm.png";}
            else if (craban >= 5) {mnucrab.src = "textures/crab1w3mm.png";}
            mnucrabpos++;
            mnucrab.style.left = `${45 - mnucrabpos / 7.5}%`;
            mnusign.style.left = `${45 - mnucrabpos / 7.5}%`;
        }

        if (!mm && play) {

            for (let i = 0; i < world1w * world1h; i++) {
                if (world1[i] == 1 || world1[i] == 4)
                    collisions[i] = 2;
                else if (world1[i] == 0)
                    collisions[i] = 0;
                else
                    collisions[i] = 1;
            }
            if (left && !hide) {xv += speed; d = 1}
            if (right && !hide) {xv -= speed; d = -1;}
            if (up && onground && !hide) {yv += jump; onground = false;}
            if (hide) {yv -= 2 * grav; hidden = true;}
            else hidden = false;
            yv -= grav;
            y += yv;
            yv -= yv / 10;
            x += xv;
            onground ? xv -= xv / 10 : xv -= xv / 20;
            if (y < -32 * 2 + 10) {y = -32 * 2 + 10; onground = true;}
        }
    }

    function render() {
        ctx.clearRect(0, 0, cnv.width, cnv.height);
        ctx.drawImage(sky, 0, 0, cnv.width, cnv.height);
        for (let i = 0; i < world1w * world1h; i++) {

            if (world1[i] == 0) ctx.drawImage(bl0, x + (i - Math.floor(i / world1w) * world1w) * 32, y + Math.floor(i / world1w) * 32);
            if (world1[i] == 1) ctx.drawImage(bl1, x + (i - Math.floor(i / world1w) * world1w) * 32, y + Math.floor(i / world1w) * 32);
            if (world1[i] == 2) ctx.drawImage(bl2, x + (i - Math.floor(i / world1w) * world1w) * 32, y + Math.floor(i / world1w) * 32);
            if (world1[i] == 3) ctx.drawImage(bl3, x + (i - Math.floor(i / world1w) * world1w) * 32, y + Math.floor(i / world1w) * 32);
            if (world1[i] == 4) ctx.drawImage(bl4, x + (i - Math.floor(i / world1w) * world1w) * 32, y + Math.floor(i / world1w) * 32);
            if (world1[i] == 6) ctx.drawImage(bl6, x + (i - Math.floor(i / world1w) * world1w) * 32, y + Math.floor(i / world1w) * 32);

        }
        ctx.save();
        ctx.scale(d, 1);
        ctx.translate((d < 0) ? -cnv.width + 32 : 0, 0);
        ctx.drawImage(shellmain, cnv.width / 2 - 16, cnv.height / 2 - 16, 32 * d, 32);
        if (!hidden) ctx.drawImage(crabmain, cnv.width / 2 - 16, cnv.height / 2 - 16, 32 * d, 32);
        ctx.restore();

        document.getElementById('pos').innerHTML = `Position: ${(x / 32).toFixed(1)}x, ${Math.round(y / 32).toFixed(1)}y`;
    }

    function setup() {
        mnucrab.remove();
        mnucracks.remove();
        mnushell.remove();
        mnusign.remove();
        document.getElementById('title').remove();
        document.getElementById('strt').remove();
        document.getElementById('bttntxt').remove();
        mm = false;
    }

    function win() {
        document.getElementById('win').style.display = "block";
        document.getElementById('win').play();
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, cnv.width, cnv.height);
    }

</script>